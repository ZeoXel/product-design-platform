# äº§å“è®¾è®¡å° - å‘é‡æ£€ç´¢ç³»ç»Ÿæµç¨‹è¯´æ˜

## ç³»ç»Ÿæ¶æ„ç¡®è®¤

### âœ… ä½ çš„ç†è§£ï¼ˆå®Œå…¨æ­£ç¡®ï¼‰

1. **å›¾åº“å»ºç«‹é˜¶æ®µ**ï¼šåŸºäºç”¨æˆ·äº§å“å›¾ä½¿ç”¨å›¾åƒè¯†åˆ«æ•´ç†å‡ºæ¯ä¸ªå›¾åƒçš„æç¤ºè¯ï¼Œé…ç½®ä¸ºæ­¤å›¾çš„æ£€ç´¢å‘é‡
2. **ç”¨æˆ·ä½¿ç”¨é˜¶æ®µ**ï¼šæ ¹æ®ä¸Šä¼ çš„å‚è€ƒå›¾æˆ–æ–‡æœ¬æç¤ºè¯ï¼Œé€šè¿‡å‘é‡æ£€ç´¢åŒ¹é…æœ€ç›¸å…³çš„å›¾ç‰‡ä½œä¸ºå‚è€ƒç”Ÿå›¾

---

## è¯¦ç»†æµç¨‹å›¾

```
                    ã€å›¾åº“å»ºç«‹ã€‘

äº§å“å›¾ç‰‡ â”€â”€â”€â”€â”€â”€â”
(PNG/JPG)      â”‚
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ å‹ç¼©å›¾ç‰‡ â”‚ â† scripts/upload_gallery_simple.py
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Claude åˆ†æ   â”‚ â† services/claude_service.py
          â”‚ Vision API   â”‚    analyze_image()
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        ç”Ÿæˆç»“æ„åŒ–æ•°æ®:
        {
          "elements": {
            "primary": ["çç ", "è´å£³"],
            "secondary": ["å°ç å­"],
            "hardware": ["é‡‘å±æ‰£"]
          },
          "style": {
            "tags": ["æ‰‹å·¥", "è‡ªç„¶", "ç®€çº¦"],
            "mood": "æ¸…æ–°è‡ªç„¶"
          }
        }
               â”‚
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ æ‹¼æ¥æè¿°æ–‡æœ¬  â”‚
          â”‚ "æ‰‹å·¥ è‡ªç„¶   â”‚
          â”‚  ç®€çº¦ æ¸…æ–°"  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ æ–‡æœ¬åµŒå…¥ API â”‚ â† services/embedding_service.py
          â”‚ text-embeddingâ”‚    generate_embedding()
          â”‚ -3-small     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        1536ç»´å‘é‡æ•°ç»„
        [0.23, -0.18, ...]
               â”‚
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ä¿å­˜åˆ°æ–‡ä»¶    â”‚
          â”‚ .npy + .json â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          data/gallery/
          â”œâ”€â”€ images/
          â”‚   â””â”€â”€ {uuid}.jpg
          â”œâ”€â”€ embeddings/
          â”‚   â””â”€â”€ {uuid}.npy  â† å‘é‡æ–‡ä»¶
          â””â”€â”€ metadata.json   â† å…ƒæ•°æ®
```

```
                    ã€ç”¨æˆ·æ£€ç´¢ã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ç”¨æˆ·è¾“å…¥                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€‰é¡¹1: ä¸Šä¼ å‚è€ƒå›¾                              â”‚
â”‚  é€‰é¡¹2: è¾“å…¥æ–‡å­—æè¿°                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ åˆ¤æ–­è¾“å…¥ç±»å‹ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚         â”‚
    ä¸Šä¼ å›¾ç‰‡       çº¯æ–‡å­—
          â”‚         â”‚
          â–¼         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚Claudeåˆ†æâ”‚   â”‚
    â”‚ç”Ÿæˆæè¿°  â”‚   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â”‚         â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ æ–‡æœ¬åµŒå…¥  â”‚ â† embedding_service
          â”‚ â†’ å‘é‡    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  å‘é‡æ£€ç´¢å¼•æ“     â”‚ â† gallery_service
          â”‚                  â”‚    find_similar()
          â”‚  for æ¯å¼ å›¾åº“å›¾: â”‚
          â”‚    è®¡ç®—ç›¸ä¼¼åº¦    â”‚
          â”‚    = cos(æŸ¥è¯¢å‘é‡, å›¾åº“å‘é‡)
          â”‚                  â”‚
          â”‚  æ’åº Top-K      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        è¿”å›ç›¸ä¼¼å›¾ç‰‡åˆ—è¡¨
        [
          {id: "abc", similarity: 0.89},
          {id: "def", similarity: 0.82},
          ...
        ]
               â”‚
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ å‰ç«¯å±•ç¤º  â”‚
          â”‚ ç”¨æˆ·é€‰æ‹©  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ å‘é€ç»™   â”‚
          â”‚ AIç”Ÿå›¾   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒä»£ç ä½ç½®

### 1. å›¾åº“å»ºç«‹

**è„šæœ¬**: `scripts/upload_gallery_simple.py`

```python
# ç¬¬135-146è¡Œ: æ ¸å¿ƒæµç¨‹
analysis = create_mock_analysis(image_file.name)
text_description = f"{' '.join(analysis.style.tags)} {analysis.style.mood}"

embedding = await embedding_service.generate_embedding(
    image_base64=image_base64,
    text=text_description
)

embedding_path = embeddings_dir / f"{ref_id}.npy"
np.save(embedding_path, embedding)
```

---

### 2. æ–‡æœ¬åµŒå…¥æœåŠ¡

**æœåŠ¡**: `services/embedding_service.py`

```python
# ç¬¬32-58è¡Œ: ç”ŸæˆåµŒå…¥å‘é‡
async def generate_embedding(
    self,
    image_base64: str,
    text: Optional[str] = None
) -> Optional[np.ndarray]:
    """
    å½“å‰å®ç°: çº¯æ–‡æœ¬åµŒå…¥
    - å›¾åƒå‚æ•°ä¿ç•™ä½†ä¸ä½¿ç”¨
    - å¿…é¡»æä¾›æ–‡æœ¬æè¿°
    """
    if not text:
        return None

    payload = {
        "model": self.model,
        "input": text
    }

    # è°ƒç”¨ OpenAI API
    response = await client.post(f"{self.base_url}/embeddings", ...)
    embedding = data["data"][0]["embedding"]

    return np.array(embedding, dtype=np.float32)
```

---

### 3. ç›¸ä¼¼åº¦è®¡ç®—

**æœåŠ¡**: `services/embedding_service.py`

```python
# ç¬¬96-123è¡Œ: ä½™å¼¦ç›¸ä¼¼åº¦
@staticmethod
def compute_similarity(emb1: np.ndarray, emb2: np.ndarray) -> float:
    """è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦"""
    # å½’ä¸€åŒ–
    emb1 = emb1 / np.linalg.norm(emb1)
    emb2 = emb2 / np.linalg.norm(emb2)

    # ç‚¹ç§¯ = ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆå½“å‘é‡å½’ä¸€åŒ–åï¼‰
    similarity = float(np.dot(emb1, emb2))

    return max(0.0, min(1.0, similarity))  # é™åˆ¶åœ¨ 0-1 èŒƒå›´
```

---

### 4. å›¾åº“æ£€ç´¢æœåŠ¡

**æœåŠ¡**: `services/gallery_service.py` (éœ€å®ç°)

```python
def find_similar(
    self,
    query_embedding: np.ndarray,
    top_k: int = 5,
    threshold: float = 0.5
) -> List[Dict]:
    """æŸ¥æ‰¾ç›¸ä¼¼å›¾ç‰‡"""
    similarities = []

    # éå†æ‰€æœ‰å›¾åº“å›¾ç‰‡
    for item in self.metadata["items"]:
        ref_id = item["id"]

        # åŠ è½½è¯¥å›¾çš„å‘é‡
        embedding_path = self.embeddings_dir / f"{ref_id}.npy"
        ref_embedding = np.load(embedding_path)

        # è®¡ç®—ç›¸ä¼¼åº¦
        similarity = embedding_service.compute_similarity(
            query_embedding,
            ref_embedding
        )

        # è¿‡æ»¤ä½äºé˜ˆå€¼çš„
        if similarity >= threshold:
            similarities.append({
                "id": ref_id,
                "imageUrl": f"/gallery/images/{ref_id}.jpg",
                "similarity": float(similarity),
                "metadata": item
            })

    # æ’åºå¹¶è¿”å› Top-K
    similarities.sort(key=lambda x: x["similarity"], reverse=True)
    return similarities[:top_k]
```

---

## æ•°æ®æµè½¬ç¤ºä¾‹

### ç¤ºä¾‹ï¼šç”¨æˆ·ä¸Šä¼ è‰å›¾æ‰¾å‚è€ƒ

```
1. å‰ç«¯ä¸Šä¼ å›¾ç‰‡
   POST /api/analyze
   Body: {
     "image": "base64...",
     "prompt": "åˆ†æè¿™ä¸ªæŒ‚é¥°è®¾è®¡"
   }

2. åç«¯åˆ†æ
   routes.py â†’ claude_service.analyze_image()
   è¿”å›: {
     "elements": {...},
     "style": {
       "tags": ["æµè‹", "ç²‰è‰²", "æ¸©æŸ”"],
       "mood": "ä¼˜é›…"
     }
   }

3. ç”Ÿæˆæ£€ç´¢æ–‡æœ¬
   text = "æµè‹ ç²‰è‰² æ¸©æŸ” ä¼˜é›…"

4. æ–‡æœ¬åµŒå…¥
   embedding_service.generate_embedding(text=text)
   è¿”å›: [0.23, -0.18, 0.91, ..., 0.05]  # 1536ç»´

5. å‘é‡æ£€ç´¢
   gallery_service.find_similar(query_embedding)

   éå†å›¾åº“:
   - å›¾1: cos_sim([0.23,...], [0.25,...]) = 0.92 âœ“
   - å›¾2: cos_sim([0.23,...], [0.10,...]) = 0.68
   - å›¾3: cos_sim([0.23,...], [0.21,...]) = 0.85 âœ“
   - ...

   æ’åº: [å›¾1(0.92), å›¾3(0.85), å›¾2(0.68), ...]

6. è¿”å›å‰ç«¯
   {
     "analysis": {...},
     "similarItems": [
       {
         "id": "å›¾1-uuid",
         "imageUrl": "/gallery/images/å›¾1.jpg",
         "similarity": 0.92
       },
       ...
     ]
   }

7. å‰ç«¯å±•ç¤º
   - æ˜¾ç¤ºåˆ†æç»“æœ
   - æ˜¾ç¤º 5 å¼ ç›¸ä¼¼å‚è€ƒå›¾
   - ç”¨æˆ·é€‰æ‹© â†’ å‘é€ç»™ AI ç”Ÿå›¾
```

---

## å½“å‰å®ç°çŠ¶æ€

### âœ… å·²å®Œæˆ
- [x] å›¾ç‰‡å‹ç¼©å’Œå­˜å‚¨
- [x] Claude è§†è§‰åˆ†æ
- [x] æ–‡æœ¬åµŒå…¥ç”Ÿæˆ
- [x] å‘é‡æ–‡ä»¶ä¿å­˜
- [x] å…ƒæ•°æ®ç®¡ç†
- [x] ç›¸ä¼¼åº¦è®¡ç®—ç®—æ³•

### ğŸš§ å¾…å®ç°ï¼ˆå‰ç«¯é›†æˆï¼‰
- [ ] API è·¯ç”±: POST /api/gallery/search
- [ ] gallery_service.find_similar() æ–¹æ³•
- [ ] å‰ç«¯ä¸Šä¼ å’Œå±•ç¤ºç•Œé¢
- [ ] ç”¨æˆ·é€‰æ‹©å‚è€ƒå›¾ â†’ å‘é€ç”Ÿå›¾

---

## ä¼˜åŒ–å»ºè®®

### 1. æå‡æ£€ç´¢ç²¾åº¦

**å½“å‰æè¿°**:
```python
text = "æ‰‹å·¥ è‡ªç„¶ ç®€çº¦ æ¸…æ–°è‡ªç„¶"
```

**ä¼˜åŒ–å**:
```python
text = """
æ‰‹å·¥ç¼–ç»‡çç æµè‹è€³ç¯
ä¸‰å±‚æ¸å˜è®¾è®¡ ç²‰ç™½è‰²ç³»
æ¸©æŸ”ä¼˜é›…æ°”è´¨ è½»ç›ˆä¸å è€³
é€‚åˆæ—¥å¸¸é€šå‹¤ æ˜¥å¤æ¸…çˆ½æ¬¾
å°‘å¥³æ„Ÿ ç®€çº¦ç°ä»£
"""
```

æ›´ä¸°å¯Œçš„æè¿° â†’ æ›´ç²¾å‡†çš„å‘é‡ â†’ æ›´å¥½çš„æ£€ç´¢æ•ˆæœ

---

### 2. å¤šç­–ç•¥èåˆ

```python
# ç­–ç•¥1: å‘é‡æ£€ç´¢ï¼ˆè¯­ä¹‰ç›¸ä¼¼ï¼‰
vector_results = find_by_vector(query_embedding)

# ç­–ç•¥2: æ ‡ç­¾è¿‡æ»¤ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
tag_results = filter_by_tags(["çç ", "æµè‹"])

# ç­–ç•¥3: èåˆæ’åº
final_results = merge_and_rerank(vector_results, tag_results)
```

---

### 3. ç”¨æˆ·åé¦ˆå¾ªç¯

```python
# è®°å½•ç”¨æˆ·è¡Œä¸º
log_user_click(query_id, clicked_item_id, similarity)

# åˆ†æç‚¹å‡»åˆ†å¸ƒ
# - é«˜ç›¸ä¼¼åº¦è¢«ç‚¹å‡» â†’ ç³»ç»Ÿå‡†ç¡® âœ“
# - ä½ç›¸ä¼¼åº¦è¢«ç‚¹å‡» â†’ éœ€è¦ä¼˜åŒ–æè¿°
```

---

## æ€»ç»“

ä½ çš„ç†è§£å®Œå…¨å‡†ç¡®ï¼æ ¸å¿ƒæµç¨‹å°±æ˜¯ï¼š

**å»ºç«‹é˜¶æ®µ**:
```
äº§å“å›¾ â†’ Claudeè¯†åˆ« â†’ æ–‡æœ¬æè¿° â†’ å‘é‡åµŒå…¥ â†’ å­˜å‚¨
```

**æ£€ç´¢é˜¶æ®µ**:
```
ç”¨æˆ·è¾“å…¥ â†’ æ–‡æœ¬æè¿° â†’ å‘é‡åµŒå…¥ â†’ ç›¸ä¼¼åº¦è®¡ç®— â†’ è¿”å›Top-K
```

**å…³é”®ç‚¹**:
1. âœ… å›¾åº“å’ŒæŸ¥è¯¢ä½¿ç”¨ç›¸åŒçš„åµŒå…¥æ–¹å¼ï¼ˆæ–‡æœ¬ï¼‰
2. âœ… å‘é‡ç»´åº¦ä¸€è‡´ï¼ˆ1536ç»´ï¼‰
3. âœ… ç›¸ä¼¼åº¦ç®—æ³•ç»Ÿä¸€ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
4. âœ… æè¿°è´¨é‡å†³å®šæ£€ç´¢ç²¾åº¦

ç³»ç»Ÿå·²ç»å¯ä»¥å·¥ä½œï¼Œæ¥ä¸‹æ¥åªéœ€è¦å®ç°å‰ç«¯ç•Œé¢å’Œ API è·¯ç”±å³å¯ï¼
