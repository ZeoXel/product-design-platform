# 向量检索与 Agent 优化方案

> 版本：v1.0
> 日期：2024-12-24
> 状态：方案设计

---

## 一、背景与目标

### 1.1 产品定位

**AI产品设计台** - 面向配饰行业的设计稿生成工具，核心价值链：

```
创意构思 → 设计出图 → 成本核算 → 落地生产
```

### 1.2 核心用户需求

| 需求 | 描述 |
|------|------|
| 快速可视化 | 把想法变成图 |
| 符合垂类 | 生成的是配饰，不是别的东西 |
| 可落地 | 图中元素都能采购到 |
| 成本透明 | 知道大概多少钱 |
| 可迭代 | 改动不会走形 |

### 1.3 优化目标

1. **提升生成质量**：生成结果更符合配饰垂类特征
2. **增强专业性**：Agent 具备配饰设计专业知识
3. **稳定输出**：减少生成结果的随机性和偏差

---

## 二、向量检索角色重定位

### 2.1 原定位 vs 新定位

| 维度 | 原定位（过重） | 新定位（精准） |
|------|---------------|---------------|
| Prompt优化 | 核心基础 | → 辅助参考 |
| 成本预估 | 主要依据 | → 不再承担 |
| 元素约束 | 约束来源 | → 不再承担 |
| 核心定位 | 必需能力 | → 辅助功能 |

### 2.2 向量检索的精简职能

```
┌─────────────────────────────────────────────────────────────┐
│                  向量检索保留功能                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. "找类似款" - 用户上传图片，找图库中相似设计             │
│  2. "风格参考" - 确保设计风格一致性                         │
│  3. "市场验证" - 看看市场上有没有类似设计                   │
│  4. "灵感探索" - 帮助用户发现设计灵感                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 不再承担的职能

- ❌ 作为 prompt 优化的技术基础（改用模板库）
- ❌ 作为成本预估的数据依据（改用元素库+价格表）
- ❌ 作为元素约束的来源（改用 Claude 分析结果）

---

## 三、Agent 能力增强方案

### 3.1 核心思路

将图库真实产品数据转化为 Agent 的"专业知识"，而非运行时检索。

```
图库真实产品
      │
      ▼
┌─────────────────────────────────────────────────────────────┐
│                      知识提取层                              │
│                                                             │
│  • 元素组合模式（什么元素搭配效果好）                       │
│  • 风格-元素映射（波西米亚风格常用什么元素）                │
│  • 成功 prompt 模式（生成效果好的 prompt 特征）             │
│  • 结构规律（挂饰的典型结构是什么）                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────────────────┐
│                    Agent 能力增强                            │
│                                                             │
│  • Few-shot 示例库                                          │
│  • 专业知识库                                               │
│  • Prompt 模板库                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、技术实现路径

### 4.1 路径一：Few-shot 示例增强（推荐首选）

#### 原理

将真实产品的"分析结果→生成prompt"作为示例，注入到 System Prompt，Claude 从示例中学习模式。

#### 实现方式

**System Prompt 示例结构：**

```
你是专业的配饰设计师。以下是一些成功的设计案例：

【案例1】海洋风钥匙扣
分析结果：主元素-贝壳/海星，辅助-蓝色珠子×5，五金-龙虾扣
生成prompt：A ocean-themed keychain charm with shell and starfish
           pendant, decorated with 5 blue glass beads, lobster
           clasp attachment, coastal color palette...

【案例2】波西米亚包挂
分析结果：主元素-流苏/木珠，辅助-彩色珠子，五金-登山扣
生成prompt：A bohemian bag charm with tassel and wooden beads...

【案例3】简约金属挂饰
...

请参考以上案例的分析和prompt风格，为用户生成设计。
```

#### 优缺点

| 优点 | 说明 |
|------|------|
| 无需模型训练 | 改配置即可生效 |
| 效果立竿见影 | Claude 天然擅长 few-shot learning |
| 灵活可调 | 可根据场景动态选择示例 |

| 缺点 | 说明 |
|------|------|
| 示例数量受限 | Context 长度限制 |
| 需人工筛选 | 示例质量影响效果 |

#### 实现复杂度

⭐⭐（低）- 预计 1-2 天

---

### 4.2 路径二：Prompt 模式挖掘

#### 原理

从真实产品中挖掘"什么样的 prompt 生成什么样的效果"的规律，形成可复用的模板库。

#### 实现流程

**Step 1: 反向工程理想 prompt**

对每个真实产品图片，让 Claude 生成"如果要生成这个产品，应该用什么 prompt"。

**Step 2: 分析 prompt 模式**

```
• 提取高频词汇和句式
• 归纳风格-关键词映射
• 总结结构描述模式
```

**Step 3: 形成模板库**

```json
{
  "ocean_style": {
    "keywords": ["coastal", "ocean", "beach", "sea", "marine"],
    "elements": ["shell", "starfish", "coral", "pearl"],
    "colors": ["ocean blue", "sandy", "turquoise", "pearl white"],
    "template": "A {adj} ocean-themed {product_type} with {element}..."
  },
  "bohemian_style": {
    "keywords": ["bohemian", "boho", "ethnic", "tribal"],
    "elements": ["tassel", "wooden beads", "feather", "woven"],
    "colors": ["earth tones", "warm colors", "natural"],
    "template": "A {adj} bohemian {product_type} featuring {element}..."
  },
  "minimalist_style": {
    "keywords": ["minimalist", "simple", "clean", "modern"],
    "elements": ["geometric", "metal", "single pendant"],
    "colors": ["monochrome", "gold", "silver", "black"],
    "template": "A {adj} minimalist {product_type} with {element}..."
  }
}
```

#### 优缺点

| 优点 | 说明 |
|------|------|
| 直接服务生成质量 | 模板来自真实产品 |
| 经过验证 | 效果有保障 |
| 一次挖掘持续受益 | 复用性高 |

#### 实现复杂度

⭐⭐⭐（中）- 预计 3-5 天

---

### 4.3 路径三：知识库 RAG 增强

#### 原理

将向量检索从"找相似产品"转变为"找相关知识"，构建专业知识库。

#### 知识库结构

```
knowledge_base/
├── element_combinations.json    # 元素组合知识
├── style_patterns.json          # 风格模式知识
├── prompt_templates.json        # 有效prompt模板
└── embeddings/                  # 向量索引
```

#### 知识条目示例

```json
{
  "type": "element_combination",
  "content": "贝壳+珍珠组合适合海洋风格，常见于夏季款式",
  "tags": ["贝壳", "珍珠", "海洋", "夏季"],
  "source_product_id": "uuid-xxx"
}
```

#### 运行时流程

```
用户输入: "做一个海洋风的挂饰"
      │
      ▼
检索相关知识条目 → 注入到 prompt 生成上下文
```

#### 优缺点

| 优点 | 说明 |
|------|------|
| 知识可持续积累 | 规模越大效果越好 |
| 检索精准 | 按知识类型而非产品整体 |
| 扩展性好 | 新知识容易加入 |

| 缺点 | 说明 |
|------|------|
| 当前规模受限 | 31个产品数据量偏小 |
| 实现复杂度高 | 需要构建知识提取流程 |

#### 实现复杂度

⭐⭐⭐⭐（中高）- 预计 1-2 周

#### 适用时机

当图库规模超过 100+ 产品时考虑实施。

---

## 五、渐进式实施计划

### Phase 1: Few-shot 示例增强（立即可做）

**目标**：快速验证效果，提升生成质量

**工作内容**：

| 步骤 | 内容 | 产出 |
|------|------|------|
| 1 | 从图库选取 5-10 个代表性产品 | 产品清单 |
| 2 | 为每个产品编写"分析→prompt"示例 | examples.json |
| 3 | 更新 System Prompt | 配置更新 |
| 4 | 测试生成效果 | 测试报告 |

**交付物**：
- `backend/data/examples.json` - 示例库
- 更新后的 `design_agent.py` System Prompt

**预计工期**：1-2 天

---

### Phase 2: Prompt 模式挖掘（效果验证后）

**目标**：构建专业化的 Prompt 模板库

**工作内容**：

| 步骤 | 内容 | 产出 |
|------|------|------|
| 1 | 批量为 31 个产品生成"理想 prompt" | raw_prompts.json |
| 2 | 分析归纳风格-元素-关键词映射 | style_patterns.json |
| 3 | 构建模板库 | prompt_templates.json |
| 4 | 修改 prompt 生成逻辑 | 代码更新 |

**交付物**：
- `backend/data/style_patterns.json` - 风格模式库
- `backend/data/prompt_templates.json` - 模板库
- 更新后的 `claude_service.py`

**预计工期**：3-5 天

---

### Phase 3: 知识库 RAG（规模扩大后）

**触发条件**：图库规模超过 100+ 产品

**目标**：构建可扩展的专业知识库

**工作内容**：
- 设计知识条目提取流程
- 构建向量化知识库
- 实现运行时知识检索
- 整合到 Agent 流程

**预计工期**：1-2 周

---

## 六、技术评估

### 6.1 可行性评估

| 方案 | 是否需要训练 | 复杂度 | 效果预期 | 当前适用性 |
|------|-------------|--------|---------|-----------|
| Few-shot 示例 | ❌ | 低 | ⭐⭐⭐⭐ | ✅ 立即可做 |
| Prompt 模式挖掘 | ❌ | 中 | ⭐⭐⭐⭐⭐ | ✅ 31个产品足够 |
| 知识库 RAG | ❌ | 中高 | ⭐⭐⭐⭐⭐ | ⚠️ 规模稍小 |
| 模型 Fine-tuning | ✅ | 高 | 未知 | ❌ 数据量不足 |

### 6.2 结论

基于当前 31 个图库产品：
- **不需要真正的模型训练**
- **Few-shot + Prompt 模式挖掘** 就能显著提升效果
- 待图库规模扩大后再考虑 RAG 方案

---

## 七、相关文件

### 需要修改的文件

| 文件 | 修改内容 |
|------|---------|
| `backend/agents/design_agent.py` | System Prompt 专业化 |
| `backend/services/claude_service.py` | 模板填充逻辑 |

### 需要新建的文件

| 文件 | 内容 |
|------|------|
| `backend/data/examples.json` | Few-shot 示例库 |
| `backend/data/style_patterns.json` | 风格模式库 |
| `backend/data/prompt_templates.json` | Prompt 模板库 |

---

## 八、附录

### A. 三场景统一处理

| 场景 | 触发条件 | 处理方式 |
|------|---------|---------|
| 图库素材图生图 | 选择图库产品 | 直接使用产品元数据 |
| 上传图片图生图 | 上传外部图片 | Claude 分析 → 模板填充 |
| 文生图 | 纯文字描述 | 文字解析 → 模板填充 |

### B. 成本预估独立方案

成本预估不再依赖向量检索，改用：

```
Claude 识别元素 → 匹配元素库 → 查询价格 → 计算成本
```

需要另行构建：
- `backend/data/element_library.json` - 元素价格库
- `backend/services/cost_service.py` - 成本计算服务
